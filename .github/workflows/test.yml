name: Spider-Guesser CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ•·ï¸ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov requests
    
    - name: ğŸ§ª Run Health Check Test
      run: |
        python -c "
        from app import app
        import json

        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200
            data = json.loads(response.data)
            assert data['status'] == 'healthy'
            print('âœ… Health check passed!')
        "
    
    - name: ğŸ® Run Game Flow Test
      run: |
        python -c "
        from app import app
        import json

        with app.test_client() as client:
            # Test start game
            response = client.post('/game/start',
                json={'player_name': 'TestHero', 'difficulty': 'easy'})
            assert response.status_code == 201
            game_data = json.loads(response.data)
            game_id = game_data['game_id']
            print(f'âœ… Game started: {game_id}')
            
            # Test make guess
            response = client.post(f'/game/{game_id}/guess',
                json={'guess': 25})
            assert response.status_code == 200
            print('âœ… Guess processed successfully!')
            
            # Test get game status
            response = client.get(f'/game/{game_id}')
            assert response.status_code == 200
            print('âœ… Game status retrieved!')
            
            # Test leaderboard
            response = client.get('/leaderboard')
            assert response.status_code == 200
            print('âœ… Leaderboard loaded!')
            
            # Test stats
            response = client.get('/stats')
            assert response.status_code == 200
            print('âœ… Stats endpoint working!')
        "
    
    - name: ğŸ› Run Error Handling Tests
      run: |
        python -c "
        from app import app
        import json

        with app.test_client() as client:
            # Test invalid game ID
            response = client.post('/game/invalid-id/guess',
                json={'guess': 25})
            assert response.status_code == 404
            print('âœ… Invalid game ID handled correctly!')
            
            # Test empty player name
            response = client.post('/game/start',
                json={'player_name': '', 'difficulty': 'easy'})
            assert response.status_code == 400
            print('âœ… Empty player name validation working!')
            
            # Test invalid difficulty
            response = client.post('/game/start',
                json={'player_name': 'Test', 'difficulty': 'impossible'})
            assert response.status_code == 400
            print('âœ… Invalid difficulty validation working!')
        "
    
    - name: âœ… All Tests Passed
      run: |
        echo "ğŸ‰ All tests passed successfully!"
        echo "ğŸ•·ï¸ Spider-Guesser is ready to deploy!"

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ•·ï¸ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Linting Tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8
    
    - name: ğŸ” Run Flake8 Linter
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 app.py --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 app.py --count --exit-zero --max-line-length=127 --statistics
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ•·ï¸ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ”’ Install Safety
      run: |
        python -m pip install --upgrade pip
        pip install safety
    
    - name: ğŸ›¡ï¸ Run Security Check
      run: |
        pip install -r requirements.txt
        safety check --json || echo "âš ï¸ Security scan completed with warnings"
      continue-on-error: true